{% extends "labels/base.html" %}
{% block title %}Review Parsed Recipe{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-check2-square text-success"></i> Review Parsed Ingredients</h2>
<p class="text-muted">Recipe: <strong>{{ recipe_name }}</strong></p>

<form method="post" action="{% url 'recipe_parse_confirm' %}">
    {% csrf_token %}

    {% if matched %}
    <div class="card mb-4 p-4">
        <h5 class="text-success"><i class="bi bi-check-circle"></i> Matched Ingredients ({{ matched|length }})</h5>
        <table class="table table-sm">
            <thead><tr><th>Parsed Text</th><th>Matched To</th><th>Weight</th><th>Confidence</th></tr></thead>
            <tbody>
            {% for m in matched %}
            <tr>
                <td>{{ m.parsed_name }}</td>
                <td><strong>{{ m.db_ingredient.name }}</strong>
                    {% if m.db_ingredient.category %}<small class="text-muted">({{ m.db_ingredient.category }})</small>{% endif %}
                </td>
                <td>{{ m.weight_grams }}g</td>
                <td>
                    {% if m.confidence >= 0.9 %}
                    <span class="badge bg-success">High ({{ m.confidence|floatformat:0 }})</span>
                    {% elif m.confidence >= 0.6 %}
                    <span class="badge bg-warning">Medium ({{ m.confidence|floatformat:1 }})</span>
                    {% else %}
                    <span class="badge bg-danger">Low ({{ m.confidence|floatformat:1 }})</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if unmatched %}
    <div class="card mb-4 p-4">
        <h5 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Unmatched Ingredients ({{ unmatched|length }})</h5>
        <p class="small text-muted">Select a database ingredient to map these to, or leave empty to skip.</p>
        <table class="table table-sm">
            <thead><tr><th>Parsed Text</th><th>Weight</th><th>Map To</th></tr></thead>
            <tbody>
            {% for u in unmatched %}
            <tr>
                <td>{{ u.name }}</td>
                <td>
                    <input type="number" name="manual_weight_{{ forloop.counter0 }}" 
                           value="{{ u.weight_grams }}" class="form-control form-control-sm" style="width:100px" step="0.1">
                </td>
                <td>
                    <select name="manual_ing_{{ forloop.counter0 }}" class="form-select form-select-sm">
                        <option value="">-- Skip --</option>
                        {% for ing in all_ingredients %}
                        <option value="{{ ing.id }}">{{ ing.name }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-check-lg"></i> Create Recipe
        </button>
        <a href="{% url 'recipe_parse' %}" class="btn btn-outline-secondary btn-lg">Back to Parser</a>
    </div>
</form>
{% endblock %}
